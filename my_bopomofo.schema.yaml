# Rime schema
# encoding: utf-8

schema:
  schema_id: my_bopomofo
  name: 我的注音
  version: '0.0.0.7'
  author:
    - 居正中 AlanJui <alanjui.1960@gmail.com>
  description: |
    實驗用專案。

    本方案採用「無模式」設計，以大寫字母鍵或上下方向鍵、回車鍵選詞；
    空格鍵輸入第一聲，標記爲「ˉ」。

    請配合 librime>=1.3 使用。
  dependencies:
    - stroke

switches:
  - name: ascii_mode
    reset: 0
    states: [漢文, ABC]
  - name: full_shape
    reset: 0
    states: [半形, 全形]
engine:
  processors:
    - ascii_composer
    - recognizer
    - key_binder
    - speller
    - punctuator
    - selector
    - navigator
    - fluency_editor
    #### 0.2 版 (含) 之前使用的是沒有佇列功能的 express_editor。
    #### 為了更彈性地選字，0.3 板之後換為 fluency_editor。
    # - express_editor
  segmentors:
    - ascii_segmentor
    - matcher
    - abc_segmentor
    - affix_segmentor@learning
    - affix_segmentor@zhuyin
    # - affix_segmentor@pinyin
    - punct_segmentor
    - fallback_segmentor
    # - affix_segmentor@custom_reverse_lookup
  translators:
    # - echo_translator
    - punct_translator
    - script_translator
    # - r10n_translator    # aka script_translator
    # - reverse_lookup_translator
    - script_translator@learning
    # - table_translator@bopomo_onion_phrase
    - script_translator@zhuyin
  filters:
    - simplifier
    - uniquifier
    - reverse_lookup_filter@tsuim_reverse_lookup_hidepinyin
    - reverse_lookup_filter@tsuim_reverse_lookup
    # - reverse_lookup_filter@bpm_reverse_lookup

#### 候選字列表中的編號保持預設 (1234567...)。
# menu:
#   alternative_select_keys: "1234567"

speller:
  alphabet: '1!qa2wsxeEdDcrRfvyYhn8*iIkoO9(lL,<m0p;:/-uUjJ 43btgz657'
  initials: '1!qa2wsxeEdDcrRfvyYhn8*iIkoO9(lL,<m0p;:/-uUjJ43btgz657'
  finals: " 43657"
  delimiter: "'"
  use_space: true
  algebra:
    # __patch:
    #   - tsuim:/pinyin_to_tsuim
    #   - tsuim:/abbreviation
    #   - tsuim:/keymap_bopomofo
    #=================================================================
    - xform/tsh(?=i)/C/      # ㄑ -- tsh 後面接 i 時，tsh 為 ㄑ
    - xform/tsh/c/           # ㄘ
    - xform/ts(?=i)/Z/       # ㄐ -- ts 後面接 i 時，ts 為 ㄐ
    - xform/ts/z/            # ㄗ
    - xform/ph/P/            # ㄆ
    - xform/th/T/            # ㄊ
    - xform/kh/K/            # ㄎ
    - xform/s(?=i)/S/        # ㄒ -- s 後面接 i 時，s 為 ㄒ
    - xform/j(?=i)/J/        # ㆢ -- j 後面接 i 時，j 為 ㆢ
    - xform/ainn/Y/          # ㆮ
    - xform/aunn/X/          # ㆯ
    - xform/ann/A/           # ㆩ
    - xform/onn/Q/           # ㆧ
    - xform/enn/E/           # ㆥ
    - xform/inn/I/           # ㆪ
    - xform/unn/U/           # ㆫ
    - xform/ang/[/           # ㄤ
    - xform/ong/]/           # ㆲ
    - xform/(?<=i)ng/R/      # ㄥ (1) -- ng 前面是 i 的時候，ng 為 ㄥ
    - xform/^ng11$/R1/       # ㄥ (2) -- 比對 "ng11" (注音ㄥ在 extended.dict.yaml 中有著特殊拼法 "ng11" 以避免衝突，此規則專門用來打注音ㄥ)
    - xform/ng(?![1-9])/G/   # ㄫ -- ng 後面不接調號 (也就是說 ng 後面會有一個母音) 時，ng 為 ㄫ
    - xform/ng/r/            # ㆭ -- 除了 ㄤ、ㆲ、ㄥ、ㄫ以外出現 ng 的情況
    - xform/ai/y/            # ㄞ
    - xform/au/x/            # ㄠ
    - xform/oo/O/            # ㆦ (1)
    - xform/o(?=[kpt])/O/    # ㆦ (2) -- o 後面接 k, p 或 t 時，o 為 ㆦ (注意 -oh 對應到 ㄜㆷ)
    - xform/am/{/            # ㆰ
    - xform/om/}/            # ㆱ
    - xform/(?<=[eiu])m/M/   # ㆬ (1) -- m 前面接 e, i 或 u 時，m 為ㆬ
    - xform/^m(?=[1-9])/M/   # ㆬ (2) -- 比對單 m 接聲調符號
    - xform/an/0/            # ㄢ
    - xform/(?<=[iu])n/N/    # ㄣ (1) -- n 前面接 i 或 u 時，n 為ㄣ
    - xform/^n(?=[1-9])/N/   # ㄣ (2) -- 比對單 n 接聲調符號 (打注音ㄣ專用)
    - xform/p4/91/           # ㆴ (1) -- 比對第四聲 (p4 轉換為 ㆴ+ 空白鍵)
    - xform/p(?=8)/9/        # ㆴ (2) -- 比對第八聲 (p 轉換為 ㆴ，8 會在其他規則中轉換為輕聲鍵)
    - xform/t4/>1/           # ㆵ (1) -- 以下規則請參考ㆴ的註解
    - xform/t(?=8)/>/        # ㆵ (2)
    - xform/k4/<1/           # ㆻ (1) 
    - xform/k(?=8)/</        # ㆻ (2)
    - xform/h4/41/           # ㆷ (1) 
    - xform/h(?=8)/4/        # ㆷ (2)
    #=================================================================
    # ==== 免打聲調 ====
    #### "49><" 對應的是四聲或八聲使用的 ㆷㆴㆵㆻ (見上方規則)
    #### "12357" 對應的是其他五個聲調的調號 ((無調號) ˋ ˪ ˊ ˫)
    - abbrev/^(.+[49><])[18]$/$1/        # 只要打 ㆷㆴㆵㆻ 就會搜尋到四聲與八聲的音 (1)
    - abbrev/^(.+)[49><].$/$1/           # 只要打聲母與韻母，就會顯示四聲與八聲的音 (2)
    - abbrev/^(.+)[12357]$/$1/           # 只要打聲母與韻母，就會顯示一二三五七聲的音 (部分規則與 #1 重疊)
    # ==== 免打注音 ====
    - abbrev/^(.)(.)[12357]$/$1/         # 對於具有聲母 + 韻母拼法且為一二三五七聲的音，只要打聲母就能夠搜尋 (部分跟 #2 重疊) (3)
    - abbrev/^(.)(.)(.)[12357]$/$1$2/    # 對於具有聲母 + 介音 + 韻母拼法且為一二三五七聲的音，只要打聲母 + 介音就能夠搜尋 (部分跟 #3 重疊)
    - abbrev/^(.)(.)(.)[12357]$/$1/      # 對於具有聲母 + 介音 + 韻母拼法且為一二三五七聲的音，只要打聲母就能夠搜尋 (4)
    - abbrev/^(.)(.)[49><][18]$/$1/      # 對於具有聲母 + 韻母拼法且為四或八聲的音，只要打聲母就能夠搜尋 (部分與 #4 重疊)
    - abbrev/^(.)(.)(.)[49><][18]$/$1$2/ # 對於具有聲母 + 介音 + 韻母拼法且為四或八聲的音，只要打聲母 + 介音就能夠搜尋
    - abbrev/^(.)(.)(.)[49><][18]$/$1/   # 對於具有聲母 + 介音 + 韻母拼法且為四或八聲的音，只要打聲母就能夠搜尋
    #=================================================================
    - 'xlit|pbPmtTnlkgKGhZJCSzjcsaAOQoeEyYxX{}M0N[]RriIuU1239><4578|1!qa2wsxeEdDcrRfvyYhn8*iIkoO9(lL,<m0p;:/-uUjJ 43btgz657|'
    #=================================================================

translator:
  dictionary: tl_ji_khoo_peh_ue
  prism: my_bopomofo
  spelling_hints: 20
  # enable_sentence: true
  preedit_format:
    - "xlit|1!qa2wsxeEdDcrRfvyYhn8*iIkoO9(lL,<m0p;:/-uUjJ 43btgz657|ㄅㆠㄆㄇㄉㄊㄋㄌㄍㆣㄎㄫㄏㄐㆢㄑㄒㄗㆡㄘㄙㄚㆩㆦㆧㄜㆤㆥㄞㆮㄠㆯㆰㆱㆬㄢㄣㄤㆲㄥㆭㄧㆪㄨㆫ ˋ˪ㆴㆵㆻㆷˊ˫˙|"
  # comment_format:
  #   __patch:
  #     - tsuim:/pinyin_to_tsuim
  #     - tsuim:/keymap_bopomofo
  #     - tsuim:/bopomofo_symbols

#### 注音顯示模式的設定
learning:
  tag: learning
  dictionary: moetaigi
  prism: tsuim
  tips: 《注音顯示》
  spelling_hints: 6
  prefix: "'"    # 啟動碼
  preedit_format:
    - "xlit|1!qa2wsxeEdDcrRfvyYhn8*iIkoO9(lL,<m0p;:/-uUjJ 43btgz657|ㄅㆠㄆㄇㄉㄊㄋㄌㄍㆣㄎㄫㄏㄐㆢㄑㄒㄗㆡㄘㄙㄚㆩㆦㆧㄜㆤㆥㄞㆮㄠㆯㆰㆱㆬㄢㄣㄤㆲㄥㆭㄧㆪㄨㆫ ˋ˪ㆴㆵㆻㆷˊ˫˙|"
    - xform/^/《注音顯示》/
  comment_format:
    __patch:
      - tsuim:/pinyin_to_tsuim
      - tsuim:/keymap_bopomofo
      - tsuim:/bopomofo_symbols

#### 中文反查模式的設定 (1) -- 利用中文注音打出字
zhuyin:
  tag: zhuyin
  dictionary: terra_pinyin # luna_pinyin
  prism: bopomofo_tw
  prefix: "`"    # 啟動碼
  # suffix: ;
  spelling_hints: 6
  preedit_format:
    - "xlit|1qaz2wsxedcrfv5tgbyhnujm8ik,9ol.0p;/- 6347'|ㄅㄆㄇㄈㄉㄊㄋㄌㄍㄎㄏㄐㄑㄒㄓㄔㄕㄖㄗㄘㄙㄧㄨㄩㄚㄛㄜㄝㄞㄟㄠㄡㄢㄣㄤㄥㄦˉˊˇˋ˙ |"
    - xform/^/《中文反查》/
    # - xform/([nl])v/$1ü/
    # - xform/([nl])ue/$1üe/
    # - xform/([jqxy])v/$1u/
  tips: 《中文反查》
  # closing_tips: 【蒼頡】
  # initial_quality: 0.2  # 調整該編譯器出字優先度

#### 中文注音反查的設定 (2) -- 對於不存在台語注音的漢字詞，在註解中把拼音隱藏起來，並顯示【無台語注音】
tsuim_reverse_lookup_hidepinyin:
  tags: [ zhuyin ]
  overwrite_comment: true
  dictionary: terra_pinyin
  comment_format:
    # - erase/^.*$/
    - xform/^.*$/【無台語注音】/
    # - xform/d/ /


#### 中文反查模式的設定 (3) -- 如果漢字詞有台語注音，就在候選項後面顯示
tsuim_reverse_lookup:
  tags: [ zhuyin ]
  overwrite_comment: true
  dictionary: moetaigi.unspaced
  comment_format:
    __patch:
      - tsuim:/pinyin_to_tsuim
      - tsuim:/keymap_bopomofo
      - tsuim:/bopomofo_symbols


# custom_reverse_lookup:
#   tag: custom_reverse_lookup
#   dictionary: cangjie5 # luna_pinyin # cangjie5
#   enable_completion: false
#   enable_sentence: false
#   enable_user_dict: true
#   # prefix: "`"
#   prefix: "="
#   suffix: " "
#   tips: "《喔喔4》"
#   preedit_format:
#   #   - xform/([nljqxy])v/$1ü/
#    - "xlit|abcdefghijklmnopqrstuvwxyz|ABCDEFGHIJKLMNOPQRSTUVWXYZ|"
#    - "xlit|abcdefghijklmnopqrstuvwxyz|日月金木水火土竹戈十大中一弓人心手口尸廿山女田難卜符|"
#    - xform/^/《反查》/
#    - 'xform/\\/ /'

# reverse_lookup:
#   dictionary: moetaigi # luna_pinyin # moetaigi-tsuim-index #  # 新增了字典檔 可能用不上
#   prefix: "`"
#   tips: 〔學習模式〕
#   preedit_format:
#     - "xlit|1!qa2wsxeEdDcrRfvyYhn8*iIkoO9(lL,<m0p;:/-uUjJ 43btgz657|ㄅㆠㄆㄇㄉㄊㄋㄌㄍㆣㄎㄫㄏㄐㆢㄑㄒㄗㆡㄘㄙㄚㆩㆦㆧㄜㆤㆥㄞㆮㄠㆯㆰㆱㆬㄢㄣㄤㆲㄥㆭㄧㆪㄨㆫ ˋ˪ㆴㆵㆻㆷˊ˫˙|"
#   comment_format:
#     __patch:
#       - tsuim:/pinyin_to_tsuim
#       - tsuim:/keymap_bopomofo
#       - tsuim:/bopomofo_symbols



#reverse_lookup:
#  dictionary: luna_pinyin
#  prefix: "`"
#  tips: 〔拼音〕
#  preedit_format:
#    - xform/([nljqxy])v/$1ü/

# tsuim_reverse_lookup:
#   tags: [ custom_reverse_lookup ]
#   overwrite_comment: true
#   dictionary: bopomo_onion.extended
#   comment_format:
#     - xform/iu/iou/
#     - xform/ui/uei/
#     - xform/ong/ung/
#     - xform/yi?/i/
#     - xform/wu?/u/
#     - xform/iu/v/
#     - xform/([jqx])u/$1v/
#     - xform/([iuv])n/$1en/
#     - xform/zhi?/Z/
#     - xform/chi?/C/
#     - xform/shi?/S/
#     - xform/([zcsr])i/$1/
#     - xform/ai/A/
#     - xform/ei/I/
#     - xform/ao/O/
#     - xform/ou/U/
#     - xform/ang/K/
#     - xform/eng/G/
#     - xform/an/M/
#     - xform/en/N/
#     - xform/er/R/
#     - xform/eh/E/
#     - xform/([iv])e/$1E/
#     - xform/1//
#     - 'xlit|bpmfdtnlgkhjqxZCSrzcsiuvaoeEAIOUMNKGR2345|ㄅㄆㄇㄈㄉㄊㄋㄌㄍㄎㄏㄐㄑㄒㄓㄔㄕㄖㄗㄘㄙㄧㄨㄩㄚㄛㄜㄝㄞㄟㄠㄡㄢㄣㄤㄥㄦˊˇˋ˙|'

punctuator:
  # import_preset: moetaigi-tsuim-symbols  # (之後視情況可能會移到這裡放)
  #### 依照教育部《重訂標點符號手冊》排序
  #### https://language.moe.gov.tw/001/upload/files/site_content/m0001/hau/haushou.htm
  full_shape: &symtable
    ">" : { commit: "。" }
    "." : { commit: "，" }
    "\"" : { commit: "、" }
    "\\" : { commit: "；" }
    "=" : { commit: "：" }
    "?" : { commit: "？" }
    "[" : [ "「", "〈" ]
    "]" : [ "」", "〉"]
    "{" : { commit: "（" }
    "}" : { commit: "）" }
    "?" : { commit: "？" }
    "|" : { commit: "！" }
    "_" : { commit: "─" }
    "+" : [ "‧" ]
    "~" : { commit: "～" }
  half_shape: *symtable
  symbols:
    "[[" : [ "『", "《" ]
    "]]" : [ "』", "》" ]
    "++" : [ "…" ]
    "+++" : [ "…" ]

recognizer:
  # import_preset: default
  patterns:
    punct: "[[]{2}$|[]]{2}$|[+]{2,3}$"    # 比對 "[[", "]]", "++", 和 "+++"
    # reverse_lookup: "`[a-z]*$"   # wrong pattern
    # reverse_lookup: "`.*$"
    # custom_reverse_lookup: "`[a-z]*$"   # wrong pattern
    learning: "'.*$"
    zhuyin: "`.*$"

editor:
  bindings:
    #### 因為 space 與一聲的鍵位衝突，因此設定 NumLock 為把待選字送到佇列的按鈕，之後在 key_binder 底下再把 space 設成跟 NumLock 有一樣的功能。
    Num_Lock: toggle_selection
    #### Return 鍵在 fluency editor 的設定下的預設功能已經是把所有字送上螢幕。
    # Return: confirm

key_binder:
  # import_preset: default
  bindings:
    #### 當有候選字列表時，space 的作用是 NumLock，如果沒有候選字列表但是有佇列時，space 的作用是把字送上螢幕。
    - { when: composing, accept: space, send: Return }
    - { when: has_menu, accept: space, send: Num_Lock }
    #### 如果沒有候選字列表但是有佇列時，按下向下鍵可以再把選字列表叫回來。
    - { when: composing, accept: Down, send: Num_Lock }
    - { when: has_menu, accept: Down, send: Down }
    #### 當有候選字列表時，ctrl+數字鍵相當於送出數字小鍵盤上的數字 (這樣就可以依照候選字的編號選字)
    - { when: has_menu, accept: Control+1, send: KP_1 }
    - { when: has_menu, accept: Control+2, send: KP_2 }
    - { when: has_menu, accept: Control+3, send: KP_3 }
    - { when: has_menu, accept: Control+4, send: KP_4 }
    - { when: has_menu, accept: Control+5, send: KP_5 }
    - { when: has_menu, accept: Control+6, send: KP_6 }
    - { when: has_menu, accept: Control+7, send: KP_7 }
    - { when: has_menu, accept: Control+8, send: KP_8 }
    - { when: has_menu, accept: Control+9, send: KP_9 }


style:
  #### ==========================================================================================
  #### RIME (Windows 小狼豪版) 使用微軟雅黑作為預設字型。雅黑支援所有的臺語注音符號，但是仍存在兩個問題：
  #### 1. 某些字不遵守正體漢字在臺灣的規範寫法。 (例如「骨」、「過」)
  #### 2. 少部分位於 Unicode 擴展區的臺語漢字無法正常顯示。 (例如「足百」山)
  #### 因此，本輸入法需要使用者預先安裝指定的字型「源樣黑體」的 Light 字重版本。
  font_face: 源樣黑體 L
