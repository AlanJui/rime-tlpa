# 輸入法版本發行作業指引

## 作業需求

### 打包規則（預設）

- ALL：release-include.txt（若存在）或根目錄 _.yaml，再加上所有「鍵盤練習工具」(kb\__.schema.yaml、_\_kb_.schema.yaml)。

- TLPA：tlpa*\*.yaml/.schema.yaml、tl_ji_khoo*\*.dict.yaml，外加 COMMON（下列共用檔）。

- ZU2（注音二式）：zu_im_2\*.yaml/.schema.yaml，外加 COMMON。

- BP：bp\_\*.yaml/.schema.yaml，外加 COMMON。

- COMMON（各包都會含）：
  - keymap_piau_tian.yaml
  - lib_hau_suan_ji_tuann.yaml
  - lib_phing_im.yaml
  - lib_sip_ngoo_im.yaml
  - lib_sip_ngoo_im2.yaml
  - lib_zu_im.yaml

- 鍵盤練習工具（只進 ALL）：kb\__.schema.yaml、_\_kb\*.schema.yaml
  （避免混入 TLPA／ZU2／BP 子包，若你希望也放進各子包，把對應的 sed -i '/kb.../d' 兩行拿掉即可）

### 觸發方式

- 路線1：gh release create vX.Y.Z --target 某分支（或直接 push vX.Y.Z tag）

- 路線2：GitHub → Actions → 這個 workflow → Run workflow（填 ref 與 tag_name）

## 作業程序

採「tag觸發」，令 GitHub Actions workflow 因帶有 tag 之 commit 送入
專案容器，便啟動處理作業。

## git 作法

```bash
# 切換到 main 分支
git checkout main
git pull

# 建立版本使用之 tag 名稱
git tag v0.5 -m "rime-tlpa v0.5 發行"

# 將 tag 推送 GitHub (使 Actions workflow 作業觸發)
git push origin v0.5
```

## gh CLI 作法

（1）先將 main 分支推送入 GitHub 專案容器：

```bash
git push origin main
```

（2）透過 gh 執行 `release create` 指令：

```bash
# 從 main 分支建立 Release（會自動建立 tag v0.5）
gh release create v0.5 \
  --target main \
  -t "rime-tlpa v0.5" \
  -n "本版說明..."
```

## 設定打包黑名單

GitHub 在【發行打包作業】，基本原則：【專案容器】中所有的【目錄】、
【檔案】都會包入【Source code】壓縮檔中。若有某些【目錄】、【檔案】
不想打包，可以透過 .gitattributes 檔案來指定。

```bash
# 減肥示例：把測試、文件、開發腳本排除
_archived/         export-ignore
.vscode/           export-ignore
tests/             export-ignore
huan_ciat/          export-ignore
docs/              export-ignore
src/              export-ignore
*.xlsx             export-ignore
*.csv              export-ignore
settings_to_append.txt export-ignore
clear_rime_cache.bat export-ignore
install.bat export-ignore
install.sh export-ignore
mylist.txt export-ignore
```

## Actions workflow

使用 YAML 檔案格式，建立 workflow scripts 。

- 存放目錄： .github/workflows/
- 檔案名稱： release-yamls.yml

```yml
name: Build & Release selected YAMLs

on:
  push:
    tags:
      - "v*"
      - "kb-*"
      - "bp-*"
      - "zu-*"
  workflow_dispatch:
    inputs:
      ref:
        description: "要打包的分支或 commit SHA（例：main 或 a1b2c3d）"
        required: true
        default: "main"
      tag_name:
        description: "要建立/更新的 Release tag（例：v0.5）"
        required: true
      prerelease:
        description: "是否標記為 pre-release"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  pack-yamls:
    runs-on: ubuntu-latest

    steps:
      - name: Set variables
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.REF }}

      - name: Build release zip from root list (bash-safe)
        shell: bash
        env:
          TAG: ${{ steps.meta.outputs.TAG }}
          LIST_FILE: release-include.txt
        run: |
          set -euo pipefail

          echo "== [DEBUG] pwd: $(pwd) =="
          if [ ! -f "$LIST_FILE" ]; then
            echo "::error::$LIST_FILE 不存在（請確認已提交到 repo 根目錄）"
            exit 1
          fi

          echo "== [DEBUG] 根目錄所有 YAML（供你對照）=="
          ls -l *.yaml || true
          echo "== [DEBUG] $LIST_FILE 內容（前 200 行）=="
          sed -n '1,200p' "$LIST_FILE" || true
          echo "====================================="

          mkdir -p dist
          ZIP="dist/rime-tlpa-yamls-${TAG}.zip"
          : > filelist.txt

          # 從清單讀入檔名：
          # 1) 去 BOM（第一行可能有 \xEF\xBB\xBF）
          # 2) 去 CR（Windows \r）
          # 3) 去前後空白
          # 4) 去空行與註解（# 開頭）
          mapfile -t FILES < <(
            awk 'NR==1{sub(/^\xef\xbb\xbf/,"")}{print}' "$LIST_FILE" \
            | sed -e 's/\r$//' \
            | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' \
            | sed -e '/^$/d' -e '/^#/d'
          )

          FOUND=0
          for p in "${FILES[@]}"; do
            echo "[DEBUG] checking: >$p<"
            if [[ -f "$p" ]]; then
              echo "$p" >> filelist.txt
              echo "Added: $p"
              FOUND=$((FOUND + 1))   # ★ 修正這行
            else
              echo "::warning::Missing (root only): $p"
            fi
          done

          if (( FOUND == 0 )); then
            echo "::error::清單中的檔案在根目錄都找不到；請檢查 $LIST_FILE 與檔名大小寫。"
            exit 1
          fi

          zip -j "$ZIP" -@ < filelist.txt >/dev/null
          echo "Created: $ZIP (files: $FOUND)"
          ls -l dist

          (cd dist && sha256sum "$(basename "$ZIP")" > "$(basename "$ZIP").sha256")

      - name: Create / Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.TAG }}
          target_commitish: ${{ steps.meta.outputs.REF }}
          prerelease: ${{ steps.meta.outputs.PRERELEASE }}
          generate_release_notes: true
          files: |
            dist/*.zip
            dist/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 發行套件清單

一個純文字檔，條列各個將打包成發行套件之輸入法相關檔案（ .yaml 檔）：

```bash
# --- 鍵盤按鍵練習工具 ---
kb_hong_im.schema.yaml
kb_ipa.schema.yaml

# --- 共用函式庫/工具 ---
keymap_piau_tian.yaml
lib_hau_suan_ji_tuann.yaml
lib_phing_im.yaml
lib_sip_ngoo_im.yaml
lib_sip_ngoo_im2.yaml
lib_zu_im.yaml

# --- 支援【台語拼音（TLPA）】 ---
tlpa_phing_im.schema.yaml
tlpa_hong_im.schema.yaml
tlpa_lib_hau_suan_ji_tuann.yaml
tl_ji_khoo_ciann_ji.dict.yaml
tl_ji_khoo_kah_kut_bun.dict.yaml
tl_ji_khoo_kong_un.dict.yaml
tl_ji_khoo_nga_siok_thong.dict.yaml
tl_ji_khoo_peh_ue.dict.yaml
tl_ji_khoo_peh_ue_zu_ting.dict.yaml

# --- 支援【台語注音二式】 ---
zu_im_2_phing_im.schema.yaml
zu_im_2_hong_im.schema.yaml
zu_im_2_libs.yaml
zu_im_2_hau_suan_zzi_duann.yaml
zu_im_2.dict.yaml

# --- 支援【閩拼方案】 ---
bp_hong_im.schema.yaml
bp_phing_im.schema.yaml
bp_libs.yaml
bp_ji_khoo.dict.yaml
```

## 維護操作

### 建置 Rlease tag

建立【發行版本】tag；並觸發 release-yamls.yml 所描述之 workflow 作業。

【方法一】gh release create 指令

```bash
# 直接從指定分支或 commit 建 Release（會自動建同名 tag）
gh release create v0.4.0 \
  --target main \
  -t "rime-tlpa v0.4.0" \
  -n "本版變更說明..."

# 上面指令會觸發 workflow，跑完後 Release 會多出你要的 YAML zip 檔
```

【實例】：

```bash
PS C:\work\rime-tlpa> gh release create v0.9.1 --target main -t "rime-tlpa v0.9.1" -n "change ..."
https://github.com/AlanJui/rime-tlpa/releases/tag/v0.9.1
PS C:\work\rime-tlpa>
```

【方法二】git 指令

```bash
# 切到你要出包的分支（例如 main 或 release-branch）
git checkout main
git pull

# 建立版本標籤（請換成你的版本號）
git tag v0.4.0 -m "rime-tlpa v0.4.0"

# 推送這個 tag（這一步會觸發 GitHub Actions）
git push origin v0.4.0
```

### 刪除某 relase tag
