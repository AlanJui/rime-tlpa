# 輸入法版本發行作業指引

## 作業程序

採「tag觸發」，令 GitHub Actions workflow 因帶有 tag 之 commit 送入
專案容器，便啟動處理作業。

## git 作法

```bash
# 切換到 main 分支
git checkout main
git pull

# 建立版本使用之 tag 名稱
git tag v0.5 -m "rime-tlpa v0.5 發行"

# 將 tag 推送 GitHub (使 Actions workflow 作業觸發)
git push origin v0.5
```


## gh CLI 作法

（1）先將 main 分支推送入 GitHub 專案容器：

```bash
git push origin main
```

（2）透過 gh 執行 `release create` 指令：

```bash
# 從 main 分支建立 Release（會自動建立 tag v0.5）
gh release create v0.5 \
  --target main \
  -t "rime-tlpa v0.5" \
  -n "本版說明..."
```

## Actions workflow

使用 YAML 檔案格式，建立 workflow scripts 。

- 存放目錄： .github/workflows/
- 檔案名稱： release-yamls.yml
-

```yml
name: Build & Release selected YAMLs

on:
  push:
    tags:
      - "v*"
      - "kb-*"
      - "bp-*"
      - "zu-*"
  workflow_dispatch:
    inputs:
      ref:
        description: "要打包的分支或 commit SHA（例：main 或 a1b2c3d）"
        required: true
        default: "main"
      tag_name:
        description: "要建立/更新的 Release tag（例：v0.5）"
        required: true
      prerelease:
        description: "是否標記為 pre-release"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  pack-yamls:
    runs-on: ubuntu-latest

    steps:
      - name: Set variables
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.REF }}

      - name: Build zip with selected YAMLs
        shell: bash
        env:
          TAG: ${{ steps.meta.outputs.TAG }}
          INCLUDE_LIST: |
            kb_hong_im.schema.yaml
            kb_ipa.schema.yaml
            keymap_piau_tian.yaml
            lib_hau_suan_ji_tuann.yaml
            lib_phing_im.yaml
            lib_sip_ngoo_im.yaml
            lib_sip_ngoo_im2.yaml
            lib_zu_im.yaml
            tlpa_phing_im.schema.yaml
            tlpa_hong_im.schema.yaml
            tlpa_lib_hau_suan_ji_tuann.yaml
            tl_ji_khoo_ciann_ji.dict.yaml
            tl_ji_khoo_kah_kut_bun.dict.yaml
            tl_ji_khoo_kong_un.dict.yaml
            tl_ji_khoo_nga_siok_thong.dict.yaml
            tl_ji_khoo_peh_ue.dict.yaml
            tl_ji_khoo_peh_ue_zu_ting.dict.yaml
            zu_im_2_phing_im.schema.yaml
            zu_im_2_hong_im.schema.yaml
            zu_im_2_libs.yaml
            zu_im_2_hau_suan_zzi_duann.yaml
            zu_im_2.dict.yaml
            bp_hong_im.schema.yaml
            bp_phing_im.schema.yaml
            bp_libs.yaml
            bp_ji_khoo.dict.yaml
        run: |
          set -euo pipefail
          mkdir -p dist
          ZIP="dist/rime-tlpa-yamls-${TAG}.zip"
          : > filelist.txt

          # 去掉 CR / 空行 / 前後空白
          mapfile -t FILES < <(printf '%s\n' "$INCLUDE_LIST" | sed -e 's/\r$//' -e '/^\s*$/d' -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

          FOUND=0
          for p in "${FILES[@]}"; do
            echo "[DEBUG] checking: >$p<"
            if [[ -f "$p" ]]; then
              echo "$p" >> filelist.txt
              echo "Added: $p"
              ((FOUND++))
            else
              echo "::warning::Missing (root only): $p"
            fi
          done

          if (( FOUND == 0 )); then
            echo "::error::No files were added to the zip. Failing the job."
            exit 1
          fi

          zip -j "$ZIP" -@ < filelist.txt >/dev/null
          echo "Created: $ZIP (files: $FOUND)"
          (cd dist && sha256sum "$(basename "$ZIP")" > "$(basename "$ZIP").sha256")

      - name: Create / Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.TAG }}
          target_commitish: ${{ steps.meta.outputs.REF }}
          prerelease: ${{ steps.meta.outputs.PRERELEASE }}
          generate_release_notes: true
          files: |
            dist/*.zip
            dist/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 發行套件清單

一個純文字檔，條列各個將打包成發行套件之輸入法相關檔案（ .yaml 檔）：

```bash
# --- 鍵盤按鍵練習工具 ---
kb_hong_im.schema.yaml
kb_ipa.schema.yaml

# --- 共用函式庫/工具 ---
keymap_piau_tian.yaml
lib_hau_suan_ji_tuann.yaml
lib_phing_im.yaml
lib_sip_ngoo_im.yaml
lib_sip_ngoo_im2.yaml
lib_zu_im.yaml

# --- 支援【台語拼音（TLPA）】 ---
tlpa_phing_im.schema.yaml
tlpa_hong_im.schema.yaml
tlpa_lib_hau_suan_ji_tuann.yaml
tl_ji_khoo_ciann_ji.dict.yaml
tl_ji_khoo_kah_kut_bun.dict.yaml
tl_ji_khoo_kong_un.dict.yaml
tl_ji_khoo_nga_siok_thong.dict.yaml
tl_ji_khoo_peh_ue.dict.yaml
tl_ji_khoo_peh_ue_zu_ting.dict.yaml

# --- 支援【台語注音二式】 ---
zu_im_2_phing_im.schema.yaml
zu_im_2_hong_im.schema.yaml
zu_im_2_libs.yaml
zu_im_2_hau_suan_zzi_duann.yaml
zu_im_2.dict.yaml

# --- 支援【閩拼方案】 ---
bp_hong_im.schema.yaml
bp_phing_im.schema.yaml
bp_libs.yaml
bp_ji_khoo.dict.yaml
```


